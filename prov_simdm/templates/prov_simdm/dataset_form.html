{% extends "core/base.html" %}
{% load form_extras %}

{% block title %}SimDM Search for Datasets{% endblock %}

{% block content %}

<script>
    function update_protocols(url, selector) {
        /* Function to update the protocols in drop-down list,
         * depending on protocol-list returned from url
         */

        $.getJSON(url, function(data) {
            // add options via javascript here directly
            opt = $("select"+selector);
            window.console.log('opt: ', opt);


            old_val = opt.val();
            window.console.log('oldval: ', old_val);
            // remove all existing options and replace with new
            opt.find('option').remove();

            // add 'any' option again
            opt.append($('<option/>').val('any').text('any'));

            $.each(data, function () {
                window.console.log(this.id);
                opt.append($('<option/>').val(this.id).text(this.value));
            });
            opt.val(old_val);
            opt.change();
        });
    }

    function update_parameters(url, selector) {
        /* Function to update the visible parameters depending on
         * which params are returned from a getJSON call
         */

        $.getJSON(url, function(data) {
            /* store all desired parameters (id) in an array */
            var option_list = [];
            $.each(data, function() {
                option_list.push(this.id);
            });

            if (option_list.length == 0) {
              $('div#noparams').show();
            }

            //window.console.log(option_list);
            /* search for the corresponding parameters in the hidden fields (display: none) 
             * and show them; hide the ones that don't match */
            $(selector).each( function(){
                $(this).find('div.paramrow').each( function(){
                    paramid = $(this).attr('paramfield');
                    //window.console.log('a: ', a);
                    if (option_list.indexOf(paramid) != -1) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            });
        });
    }

    function switch_gray_out(objid) {
        /* Function to gray out not-needed areas */

      if ( $("input[id='"+objid+"']").is(":checked")  ) {
          //window.console.log('checked!');
          $("div[paramid='"+objid+"']").each( function(){
            $(this).removeClass("gray");
          });
      } else {
          //window.console.log('not checked!');
          $("div[paramid='"+objid+"']").each( function(){
            $(this).addClass("gray");
          });
      }

    }


    /* document ready? Go! */
    $(function(){
        // initially hide the noparams-div
        $('div#noparams').hide();

        // update all parameter styles (based on checked or not)
        $('#parameters').find("input[fieldsettype='label']").each(
          function() {
            //window.console.log("switch off "+this.id);
            switch_gray_out(this.id);
        });

        /* if #id_protocol_type is changing, call the update_protocols-function for
         * updating the protocols-list */
        $('#id_protocol_type').change(function(){
            var selectedvalue = $('#id_protocol_type input:checked').val();
            window.console.log('protocol_type changed to ' + selectedvalue);
            update_protocols('/simdm/datasetform_protocols?protocol_type=' + selectedvalue, '#id_protocol');
        });

        /* if the field with id=id_protocol is changing, then call update_parameters-function
         * for updating the visible/hidden params */
        $('#id_protocol').change(function(){
            update_parameters('/simdm/datasetform_parameters?protocol=' + $(this).val(), '#parameters');
        });

        $("input[id='id_param_cs:inparam_forceres']").change( function() { switch_gray_out(this.id); });
        $("input[id='id_param_cs:inparam_zini']").change( function() { switch_gray_out(this.id); });
        $("input[id='id_param_cs:inparam_foflinklen']").change( function() { switch_gray_out(this.id); });
        $("input[id='id_param_cs:inparam_boxsize']").change( function() { switch_gray_out(this.id); });
        $("input[id='id_param_cs:inparam_particleres']").change( function() { switch_gray_out(this.id); });
});
</script>


<h2>SimDM Search for Datasets</h2>

<div class="row">
  <div class="col-md-6">
    Search for datasets using the specified properties.
  </div>
</div>
<form action="/simdm/datasetform/" method="post">
    {% csrf_token %}

  <fieldset id="main">
    <legend>Main properties</legend>
    {% for field in form.visible_fields %}
      {% if field.name|startswith:"param" == False %}
    <div class="row">
      <div class="col-md-2">
          {{ field.label }}:
      </div>
      <div class="col-md-4">
          {{ field }}
        <div style="clear: both"></div>
        <div>
          <span class="helptext">{{ field.help_text }}</span>
            {{ field.errors }}
        </div>
      </div>
    </div>
      {% endif %}
    {% endfor %}
  </fieldset>

  <fieldset id="parameters">
    <legend>Parameters</legend>
    <div class="row" id="noparams">
      <div class="col-md-2">
      No parameters available for this protocol.
      </div>
    </div>
    {% for field in form %}

        {% if field.name|startswith:"param_" == True %}
    <div class="row paramrow" paramfield="{{ field.name | strip_left_of_last:"_" }}">
      <div class="col-md-2">
      </div>
      <div class="col-md-2">
          {{ field }}&nbsp;&nbsp;{{ field.label }}
        <div style="clear: both"></div>
        <div>
          <span class="helptext">{{ field.help_text }}</span>
            {{ field.errors }}
        </div>
      </div>
          {% elif field.name|startswith:"paramvalue_" == True %}
      <div class="col-md-4" paramid="id_{{ field.name|cut:"value" }}">
          {{ field }}
        <div style="clear: both"></div>
        <div>
          <span class="helptext">{{ field.help_text }}</span>
            {{ field.errors }}
        </div>
      </div>
    </div> <!-- row -->
        {% endif %}


    {% endfor %}

  </fieldset>

  <fieldset id="submit">
    <hr>
    <div class="row">
      <div class="col-md-2"></div>
      <div class="col-md-4">
        <input type="submit" name="submit" value="Submit"/>
      </div>
    </div>
  </fieldset>

</form>

{% endblock %}