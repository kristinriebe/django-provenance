{% extends "core/base.html" %}
{% load form_extras %}

{% block title %}SimDM Search for Datasets{% endblock %}

{% block content %}

<script>
    function update_parameters(url, selector) {
        /* Function to update the visible parameters depending on
         * which params are returned from a getJSON call
         */

        $.getJSON(url, function(data) {
            /* store all desired parameters in an array */
            var option_list = [];
            $.each(data, function() {
                option_list.push(this.id);
            });

            /* search for the corresponding parameters in the hidden fields (display: none) 
             * and show them; hide the ones that don't match */
            $(selector).each( function(){
                $(this).find('li').each( function(){
                    e = $(this).find('label input')
                    a = e.attr('value');
                    if (option_list.indexOf(a) != -1) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            });

            // alternative: add options via javascript here directly
            //$.each(data, function () {
            //
            //    opt.append($('<option/>').val(this.id).text(this.value));
            //});
            //opt.val(old_val);
            //opt.change();
        })
    }

    $(function(){
        /* if the field with id_parent is changing, then call update_parameters-function
         * for updating the visible/hidden params */
        $('#id_protocol').change(function(){
            update_parameters('/simdm/datasetform_parameters?protocol=' + $(this).val(), '#id_parameters');
        });
    });
</script>


<h2>SimDM Search for Datasets</h2>

<div class="row">
  <div class="col-md-6">
    Search for datasets using the specified properties.
  </div>
</div>
<form action="/simdm/datasetform/" method="post">
    {% csrf_token %}

    {% for field in form.visible_fields %}
      {% if field.name|startswith:"param" == False %}
  <div class="row">
    <div class="col-md-2">
          {{ field.label }}:
    </div>
    <div class="col-md-4">
          {{ field }}
     <div style="clear: both"></div>
      <div>
        <span class="helptext">{{ field.help_text }}</span>
          {{ field.errors }}
      </div>
    </div>
  </div>
      {% endif %}
    {% endfor %}

  <fieldset class="parameters">
    <legend>Parameters</legend>
    {% for field in form.visible_fields %}


        {% if field.name|strip_right_of:"_"  == "param" %}
  <div class="row">
    <div class="col-md-2">
          {{ field.label }}:
    </div>
    <div class="col-md-4">
          {{ field }}
      <div style="clear: both"></div>
        <div>
          <span class="helptext">{{ field.help_text }}</span>
            {{ field.errors }}
        </div>
      </div>
    </div>
        {% endif %}

    {% endfor %}

  </fieldset>

 
  <div class="row">
    <div class="col-md-2"></div>
    <div class="col-md-4">
      <input type="submit" name="submit" value="Submit"/>
    </div>
  </div>

</form>

{% endblock %}